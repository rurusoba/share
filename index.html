<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; frame-src https://www.youtube.com https://embed.nicovideo.jp https://open.spotify.com; connect-src 'self' https:; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>ãŠã™ã™ã‚æ¥½æ›² Share</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 25%, #fecfef 50%, #a8edea 75%, #fed6e3 100%);
            background-size: 400% 400%;
            animation: marbleShift 15s ease-in-out infinite;
            color: #333;
        }

        @keyframes marbleShift {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 25%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 0% 75%; }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.4) 2px, transparent 2px),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.3) 1px, transparent 1px),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.5) 1.5px, transparent 1.5px),
                radial-gradient(circle at 60% 40%, rgba(255,192,203,0.3) 1px, transparent 1px);
            background-size: 80px 80px, 120px 120px, 150px 150px, 200px 200px;
            pointer-events: none;
            z-index: -1;
            animation: sparkle 8s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        h1 {
            color: #444;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: textShimmer 3s ease-in-out infinite;
        }

        @keyframes textShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        p {
            color: #555;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        #player-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,192,203,0.4);
            border-radius: 20px;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(255,182,193,0.4), 0 4px 20px rgba(135,206,235,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #player-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(255,182,193,0.5), 0 8px 30px rgba(135,206,235,0.4);
        }
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 18px;
        }
        button {
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #444;
            border: none;
            border-radius: 25px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 20px rgba(255,154,158,0.3);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(135deg, #fecfef, #a8edea);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,154,158,0.4);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px auto;
            max-width: 800px;
        }
        .platform-button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        .platform-button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #555;
            border: 2px solid transparent;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .platform-button.active {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.2);
            color: #ff6b9d;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.2);
        }
        .share-button {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border: 2px solid rgba(168,237,234,0.5);
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
        }
        .share-button:hover {
            background: linear-gradient(135deg, #fed6e3, #d299c2);
            border-color: rgba(254,214,227,0.8);
            transform: translateY(-3px);
        }
        #native-share-button {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
        }
        .share-button.active {
            background: linear-gradient(135deg, #ff6b9d, #4ecdc4);
            color: white;
            border-color: #ff6b9d;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        textarea {
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            padding: 18px;
            font-size: 16px;
            line-height: 1.6;
            box-sizing: border-box;
            background: rgba(255,255,255,0.8);
            color: #444;
            border: 2px solid rgba(255,192,203,0.3);
            border-radius: 15px;
            overflow-y: hidden;
            resize: none;
            backdrop-filter: blur(10px);
            display: block;
            box-shadow: 0 6px 20px rgba(255,182,193,0.2);
            transition: all 0.3s ease;
        }
        textarea::placeholder {
            color: #888;
            font-style: italic;
        }
        textarea:focus {
            outline: none;
            border-color: #ff6b9d;
            box-shadow: 0 8px 30px rgba(255, 107, 157, 0.3);
            transform: translateY(-2px);
        }
        textarea.over-limit {
            border-color: #ff4757;
            box-shadow: 0 8px 30px rgba(255, 71, 87, 0.3);
        }
        .over-limit-text {
            background-color: #ff4757;
            color: white;
        }
        #character-counter {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-top: 2px solid rgba(255,192,203,0.4);
            padding: 15px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            display: none;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 -4px 20px rgba(255,182,193,0.2);
        }
        #character-counter.over-limit {
            color: #ff4757;
            font-weight: bold;
            background: rgba(255,245,245,0.95);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        #markdown-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-top: 2px solid rgba(255,192,203,0.4);
            padding: 12px;
            display: none;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
            flex-wrap: wrap;
            box-shadow: 0 -4px 20px rgba(255,182,193,0.2);
        }
        .md-button {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid rgba(255,192,203,0.3);
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #444;
            border-radius: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
        }
        .md-button:hover {
            background: linear-gradient(135deg, #fab1a0, #fd79a8);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(253, 121, 168, 0.3);
        }
        .md-button b { font-weight: bold; }
        .md-button i { font-style: italic; }
        .md-button u { text-decoration: underline; }
        .md-button s { text-decoration: line-through; }

        #markdown-preview {
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            padding: 18px;
            font-size: 16px;
            line-height: 1.6;
            box-sizing: border-box;
            background: rgba(255,255,255,0.9);
            color: #444;
            border: 2px solid rgba(255,192,203,0.3);
            border-radius: 15px;
            min-height: 160px;
            display: none;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 20px rgba(255,182,193,0.2);
        }
        #markdown-preview a {
            color: #ff6b9d;
            text-decoration: underline;
        }
        #markdown-preview blockquote {
            border-left: 4px solid #ff6b9d;
            padding-left: 12px;
            margin-left: 8px;
            color: #666;
            background: rgba(255,107,157,0.1);
            padding: 8px 12px;
            border-radius: 8px;
        }
        #markdown-preview code {
            background: rgba(255,235,59,0.3);
            color: #e65100;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 600;
        }
        #markdown-preview .spoiler {
            background-color: #ddd;
            color: #ddd;
            padding: 2px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: color 0.3s;
        }
        #markdown-preview .spoiler:hover {
            color: #444;
            background-color: #f0f0f0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: left;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            color: #d9534f;
            font-size: 1.5em;
        }

        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .modal-content strong {
            word-break: break-all;
            font-size: 0.9em;
            color: #555;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        #agree-button {
            background: linear-gradient(135deg, #5cb85c, #4cae4c);
            color: white;
        }

        #disagree-button {
            background: linear-gradient(135deg, #f0ad4e, #eea236);
            color: white;
        }
    </style>
</head>
<body>

    <div id="warning-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«é–¢ã™ã‚‹è­¦å‘Š</h2>
            <p>å¤–éƒ¨ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚‚ã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¬¬ä¸‰è€…ã«ã‚ˆã£ã¦æä¾›ã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€äºˆæœŸã›ã¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
            <p>æä¾›å…ƒãŒä¿¡é ¼ã§ãã‚‹å ´åˆã«ã®ã¿ã€èª­ã¿è¾¼ã¿ã‚’ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            <p><strong>URL:</strong> <br><strong id="external-url"></strong></p>
            <div class="modal-buttons">
                <button id="agree-button">åŒæ„ã—ã¦èª­ã¿è¾¼ã‚€</button>
                <button id="disagree-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="player-container">
        <iframe id="youtube-player" 
                width="560" 
                height="315" 
                src="" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
        </iframe>
    </div>

    <h1 id="title-text">Share</h1>
    <p>ãƒ©ãƒ³ãƒ€ãƒ ã§æ¥½æ›²ã‚’å†ç”Ÿã—ã¾ã™ã€‚</p>

    <div id="platform-container" class="platform-button-container"></div>

    <div class="button-container">
        <button id="random-button">æ¬¡ã®æ›²ã¸</button>
        <button id="twitter-button" class="share-button">Twitter(X)</button>
        <button id="discord-button" class="share-button">Discord</button>
        <button id="other-button" class="share-button active">ãã®ä»–</button>
        <button id="native-share-button" class="share-button">å…±æœ‰</button>
        <button id="help-button">ä½¿ã„æ–¹</button>
    </div>

    <textarea id="memo-area" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." rows="10"></textarea>
    <div id="markdown-preview"></div>

    <div id="character-counter">0 / 140</div>

    <div id="markdown-toolbar">
        <button class="md-button" data-md-start="**" data-md-end="**"><b>B</b></button>
        <button class="md-button" data-md-start="*" data-md-end="*"><i>I</i></button>
        <button class="md-button" data-md-start="__" data-md-end="__"><u>U</u></button>
        <button class="md-button" data-md-start="~~" data-md-end="~~"><s>S</s></button>
        <button class="md-button" data-md-start="||" data-md-end="||">Spoiler</button>
        <button class="md-button" data-md-start="`" data-md-end="`">Code</button>
        <button class="md-button" data-md-start="> " data-md-end="">Quote</button>
        <button class="md-button" id="md-link">Link</button>
        <div style="border-left: 1px solid #ccc; margin: 0 5px;"></div>
        <button class="md-button" id="md-edit-mode">Edit</button>
        <button class="md-button" id="md-preview-mode">Preview</button>
    </div>

    <script>
        const playerContainer = document.getElementById('player-container');
        const randomButton = document.getElementById('random-button');
        const twitterButton = document.getElementById('twitter-button');
        const discordButton = document.getElementById('discord-button');
        const otherButton = document.getElementById('other-button');
        const memoArea = document.getElementById('memo-area');
        const characterCounter = document.getElementById('character-counter');
        const markdownToolbar = document.getElementById('markdown-toolbar');
        const markdownPreview = document.getElementById('markdown-preview');
        const nativeShareButton = document.getElementById('native-share-button');
        const titleText = document.getElementById('title-text');
        const platformContainer = document.getElementById('platform-container');
        const helpButton = document.getElementById('help-button');
        const warningModal = document.getElementById('warning-modal');
        const externalUrlSpan = document.getElementById('external-url');
        const agreeButton = document.getElementById('agree-button');
        const disagreeButton = document.getElementById('disagree-button');

        if (navigator.share) {
            nativeShareButton.style.display = 'inline-block';
        }

        let videoIds = {
            youtube: [],
            niconico: [],
            spotify: [],
            youtubemusic: []
        };
        let currentPlatform = '';
        let currentShareMode = 'other'; // æ¨™æº–ã¯ã€Œãã®ä»–ã€
        let currentVideoId = ''; // ç¾åœ¨å†ç”Ÿä¸­ã®å‹•ç”»ID

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½
        const rateLimiter = {
            requests: new Map(),
            maxRequests: 10, // 1åˆ†é–“ã«æœ€å¤§10å›
            timeWindow: 60000, // 1åˆ†é–“

            isAllowed() {
                const now = Date.now();
                const key = 'csv_fetch';
                
                if (!this.requests.has(key)) {
                    this.requests.set(key, []);
                }
                
                const timestamps = this.requests.get(key);
                
                // æ™‚é–“çª“å¤–ã®å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤
                const validTimestamps = timestamps.filter(t => now - t < this.timeWindow);
                this.requests.set(key, validTimestamps);
                
                if (validTimestamps.length >= this.maxRequests) {
                    console.warn('Rate limit exceeded for CSV fetching');
                    return false;
                }
                
                validTimestamps.push(now);
                return true;
            }
        };

        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç®¡ç†
        const errorLogger = {
            errors: [],
            maxErrors: 100,
            
            log(error, context = '') {
                const errorEntry = {
                    timestamp: new Date().toISOString(),
                    error: error.toString(),
                    context,
                    userAgent: navigator.userAgent.substring(0, 200) // åˆ¶é™ä»˜ãã§è¨˜éŒ²
                };
                
                this.errors.push(errorEntry);
                
                // å¤ã„ã‚¨ãƒ©ãƒ¼ã‚’å‰Šé™¤
                if (this.errors.length > this.maxErrors) {
                    this.errors.shift();
                }
                
                console.error('Error logged:', errorEntry);
            },
            
            getRecentErrors(minutes = 5) {
                const since = new Date(Date.now() - minutes * 60000);
                return this.errors.filter(e => new Date(e.timestamp) > since);
            }
        };

        // å‹•ç”»IDã®æ¤œè¨¼é–¢æ•°
        function validateVideoId(id, platform) {
            if (!id || typeof id !== 'string') return false;
            
            // ã‚µãƒ‹ã‚¿ã‚¤ã‚º: å±é™ºãªæ–‡å­—ã‚’é™¤å»
            const sanitized = id.replace(/[<>\"'&]/g, '');
            if (sanitized !== id) return false;
            
            switch (platform) {
                case 'youtube':
                case 'youtubemusic':
                    return /^[a-zA-Z0-9_-]{11}$/.test(id);
                case 'niconico':
                    return /^[a-zA-Z0-9]+$/.test(id);
                case 'spotify':
                    return /^[a-zA-Z0-9]{22}$/.test(id);
                default:
                    return false;
            }
        }

        // URLã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
        function isUrlSafe(url) {
            try {
                const parsedUrl = new URL(url);
                
                // HTTPSã®ã¿è¨±å¯
                if (parsedUrl.protocol !== 'https:') {
                    console.warn("Only HTTPS URLs are allowed");
                    return false;
                }
                
                // å±é™ºãªãƒ›ã‚¹ãƒˆåã‚’ãƒ–ãƒ­ãƒƒã‚¯
                const dangerousHosts = [
                    'localhost',
                    '127.0.0.1',
                    '0.0.0.0',
                    '::1'
                ];
                
                if (dangerousHosts.includes(parsedUrl.hostname)) {
                    console.warn("Potentially dangerous hostname blocked:", parsedUrl.hostname);
                    return false;
                }
                
                // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                const ipv4Pattern = /^(\d{1,3}\.){3}\d{1,3}$/;
                if (ipv4Pattern.test(parsedUrl.hostname)) {
                    const parts = parsedUrl.hostname.split('.').map(Number);
                    // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPãƒ¬ãƒ³ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
                    if ((parts[0] === 10) ||
                        (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||
                        (parts[0] === 192 && parts[1] === 168)) {
                        console.warn("Private IP address blocked:", parsedUrl.hostname);
                        return false;
                    }
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
                if (!parsedUrl.pathname.toLowerCase().endsWith('.csv')) {
                    console.warn("Only CSV files are allowed");
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error("URL validation failed:", e);
                return false;
            }
        }

        // URLã‹ã‚‰å‚ç…§ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹
        function getCsvPath() {
            const params = new URLSearchParams(window.location.search);
            
            // ?u=<URL> ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆ
            if (params.has('u')) {
                const url = params.get('u');
                
                // URLé•·åˆ¶é™ï¼ˆ2048æ–‡å­—ï¼‰
                if (url.length > 2048) {
                    console.error("URL too long (max 2048 characters)");
                    return 'ippitsukamome.csv';
                }
                
                if (isUrlSafe(url)) {
                    return url;
                } else {
                    console.error("Unsafe URL detected:", url);
                    return 'ippitsukamome.csv';
                }
            }
            
            // ?=***.csv or ?***.csv å½¢å¼ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
            let search = window.location.search.substring(1);
            if (search) {
                // ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ&ä»¥é™ï¼‰ã‚’åˆ‡ã‚Šæ¨ã¦ã‚‹
                search = search.split('&')[0];

                // 'u='ã§å§‹ã¾ã£ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
                if (search && !search.startsWith('u=')) {
                    const fileName = search.startsWith('=') ? search.substring(1) : search;
                    // ç°¡å˜ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (fileName.endsWith('.csv')) {
                        return decodeURIComponent(fileName);
                    }
                }
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®CSVãƒ•ã‚¡ã‚¤ãƒ«
            return 'ippitsukamome.csv';
        }

        // CSVåã‚’åŸºã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
        function updateTitle(csvPath) {
            // ãƒ‘ã‚¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åéƒ¨åˆ†ã‚’æŠ½å‡º (ä¾‹: "https://.../foo.csv" -> "foo.csv")
            const fileNameWithExt = csvPath.substring(csvPath.lastIndexOf('/') + 1);
            // æ‹¡å¼µå­ã‚’é™¤å» (ä¾‹: "foo.csv" -> "foo")
            const fileName = fileNameWithExt.replace(/\.csv$/, '');
            
            // ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã€æœ€åˆã®æ–‡å­—ã‚’å¤§æ–‡å­—ã«ã™ã‚‹ (ä¾‹: "ippitsukamome" -> "Ippitsukamome")
            const decodedFileName = decodeURIComponent(fileName);
            const capitalizedFileName = decodedFileName.charAt(0).toUpperCase() + decodedFileName.slice(1);

            // æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆ
            const newTitle = `${capitalizedFileName} Share`;
            
            // ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨H1è¦ç´ ã‚’æ›´æ–°
            titleText.textContent = newTitle;
            document.title = newTitle;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        // ç¾åœ¨ã®å‹•ç”»URLã‚’å–å¾—
        function getCurrentVideoUrl() {
            if (!currentVideoId) return '';
            switch (currentPlatform) {
                case 'youtube':
                    return `https://youtu.be/${currentVideoId}`;
                case 'niconico':
                    return `https://www.nicovideo.jp/watch/${currentVideoId}`;
                case 'spotify':
                    return `https://open.spotify.com/track/${currentVideoId}`;
                case 'youtubemusic':
                    return `https://music.youtube.com/watch?v=${currentVideoId}`;
                default:
                    return '';
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆå†…ã®URLã‚’æ¤œå‡ºã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã‚’èª¿æ•´ï¼ˆXãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function getEffectiveTextLength(text) {
            if (currentShareMode !== 'twitter') return text.length;
            
            // å„ç¨®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
            const urlPattern = /https?:\/\/[^\s]+/g;
            const urls = text.match(urlPattern) || [];
            
            let adjustedLength = text.length;
            urls.forEach(url => {
                // å®Ÿéš›ã®URLæ–‡å­—æ•°ã‹ã‚‰23æ–‡å­—ã‚’å¼•ãï¼ˆTwitterã®URLçŸ­ç¸®ï¼‰
                adjustedLength = adjustedLength - url.length + 23;
            });
            
            return adjustedLength;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å‹•ç”»URLã‚’æŒ¿å…¥
        function insertVideoUrl() {
            const videoUrl = getCurrentVideoUrl();
            if (!videoUrl) return;
            
            const currentText = memoArea.value;
            // URLãŒæ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯æŒ¿å…¥ã—ãªã„
            if (currentText.includes(videoUrl)) return;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒç©ºã®å ´åˆã¯URLã®ã¿ã€ãã†ã§ãªã‘ã‚Œã°æ”¹è¡Œã—ã¦URLè¿½åŠ 
            let newText;
            if (currentText.trim() === '') {
                newText = videoUrl;
            } else {
                newText = currentText + '\n' + videoUrl;
            }
            
            memoArea.value = newText;
            
            // é«˜ã•ã‚’èª¿æ•´
            memoArea.style.height = 'auto';
            memoArea.style.height = (memoArea.scrollHeight) + 'px';
            
            // æ–‡å­—æ•°æ›´æ–°ï¼ˆXãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰
            if (currentShareMode === 'twitter') {
                updateCharacterCounter();
            }
        }

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updateCharacterCounter() {
            const currentLength = getEffectiveTextLength(memoArea.value);
            const maxLength = 140;
            characterCounter.textContent = `${currentLength} / ${maxLength}`;
            
            if (currentLength > maxLength) {
                characterCounter.classList.add('over-limit');
            } else {
                characterCounter.classList.remove('over-limit');
            }
        }

        nativeShareButton.addEventListener('click', async () => {
            const url = getCurrentVideoUrl();
            const text = memoArea.value;
            const title = document.title;

            // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§URLãŒã‚ã‚‹å ´åˆã€ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨
            const shareText = text.trim() === '' && url ? title : text;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: shareText,
                        url: url
                    });
                } catch (error) {
                    errorLogger.log(error, 'Web Share API');
                }
            }
        });

        // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ç®¡ç†
        function setActiveShareButton(activeButton) {
            const shareButtons = [twitterButton, discordButton, otherButton];
            shareButtons.forEach(button => button.classList.remove('active'));
            activeButton.classList.add('active');
            
            // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã‚’è¨˜éŒ²
            if (activeButton === twitterButton) {
                currentShareMode = 'twitter';
                characterCounter.style.display = 'block';
                markdownToolbar.style.display = 'none';
                memoArea.style.display = 'block';
                markdownPreview.style.display = 'none';
                insertVideoUrl(); // URLã‚’è‡ªå‹•æŒ¿å…¥
                updateCharacterCounter();
            } else if (activeButton === discordButton) {
                currentShareMode = 'discord';
                characterCounter.style.display = 'none';
                markdownToolbar.style.display = 'flex';
                memoArea.style.display = 'block';
                markdownPreview.style.display = 'none';
                insertVideoUrl(); // URLã‚’è‡ªå‹•æŒ¿å…¥
            } else {
                currentShareMode = 'other';
                characterCounter.style.display = 'none';
                markdownToolbar.style.display = 'none';
                memoArea.style.display = 'block';
                markdownPreview.style.display = 'none';
                insertVideoUrl(); // URLã‚’è‡ªå‹•æŒ¿å…¥
            }
        }

        // Markdownãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        markdownToolbar.addEventListener('click', (e) => {
            const target = e.target.closest('.md-button');
            if (!target) return;

            if (target.id === 'md-link') {
                const url = getCurrentVideoUrl();
                if (url) {
                    const startPos = memoArea.selectionStart;
                    const endPos = memoArea.selectionEnd;
                    const selectedText = memoArea.value.substring(startPos, endPos) || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ';
                    const replacement = `[${selectedText}](${url})`;
                    memoArea.value = memoArea.value.substring(0, startPos) + replacement + memoArea.value.substring(endPos);
                    memoArea.focus();
                    memoArea.setSelectionRange(startPos + 1, startPos + 1 + selectedText.length);
                } else {
                    alert('ç¾åœ¨å†ç”Ÿä¸­ã®å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
                return;
            }

            if (target.id === 'md-edit-mode') {
                memoArea.style.display = 'block';
                markdownPreview.style.display = 'none';
                memoArea.focus();
                return;
            }

            if (target.id === 'md-preview-mode') {
                memoArea.style.display = 'none';
                markdownPreview.style.display = 'block';
                renderMarkdown();
                return;
            }

            const startTag = target.dataset.mdStart;
            const endTag = target.dataset.mdEnd;
            const startPos = memoArea.selectionStart;
            const endPos = memoArea.selectionEnd;
            const selectedText = memoArea.value.substring(startPos, endPos);
            
            let replacement;
            if (startTag === '> ') { // å¼•ç”¨ã®å ´åˆ
                replacement = startTag + selectedText.replace(/\n/g, '\n> ');
            } else {
                replacement = startTag + selectedText + endTag;
            }

            memoArea.value = memoArea.value.substring(0, startPos) + replacement + memoArea.value.substring(endPos);
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            memoArea.focus();
            if (selectedText) {
                memoArea.setSelectionRange(startPos + startTag.length, endPos + startTag.length);
            } else {
                memoArea.setSelectionRange(startPos + startTag.length, startPos + startTag.length);
            }
        });

        // Markdownã‚’HTMLã«å¤‰æ›ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function renderMarkdown() {
            let html = memoArea.value;
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            html = escapeHTML(html);
            // **å¤ªå­—**
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            // *æ–œä½“*
            html = html.replace(/\*(.*?)\*/g, '<i>$1</i>');
            // __ä¸‹ç·š__
            html = html.replace(/__(.*?)__/g, '<u>$1</u>');
            // ~~å–ã‚Šæ¶ˆã—ç·š~~
            html = html.replace(/~~(.*?)~~/g, '<s>$1</s>');
            // ||ã‚¹ãƒã‚¤ãƒ©ãƒ¼||
            html = html.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');
            // `ã‚³ãƒ¼ãƒ‰`
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            // > å¼•ç”¨
            html = html.replace(/^&gt; (.*$)/gm, '<blockquote>$1</blockquote>');
            // [ãƒ†ã‚­ã‚¹ãƒˆ](URL) - URLã®å®‰å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, (match, text, url) => {
                try {
                    const parsedUrl = new URL(url);
                    if (parsedUrl.protocol === 'https:' || parsedUrl.protocol === 'http:') {
                        return `<a href="${escapeHTML(url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(text)}</a>`;
                    }
                } catch (e) {
                    // ç„¡åŠ¹ãªURLã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¡¨ç¤º
                }
                return escapeHTML(text);
            });
            // æ”¹è¡Œ
            html = html.replace(/\n/g, '<br>');

            markdownPreview.innerHTML = html;
        }

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
        function createPlatformButtons() {
            platformContainer.innerHTML = '';
            const platforms = [
                { id: 'youtube', name: 'YouTube' },
                { id: 'niconico', name: 'ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»' },
                { id: 'spotify', name: 'Spotify' },
                { id: 'youtubemusic', name: 'YouTube Music' }
            ];

            platforms.forEach(platform => {
                if (videoIds[platform.id] && videoIds[platform.id].length > 0) {
                    const button = document.createElement('button');
                    button.id = `platform-${platform.id}`;
                    button.className = 'platform-button';
                    button.textContent = platform.name;
                    button.addEventListener('click', () => {
                        currentPlatform = platform.id;
                        setActivePlatformButton(button);
                        loadRandomVideo();
                    });
                    platformContainer.appendChild(button);
                }
            });

            // æœ€åˆã®åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            const firstAvailablePlatform = platforms.find(p => videoIds[p.id] && videoIds[p.id].length > 0);
            if (firstAvailablePlatform) {
                const firstButton = document.getElementById(`platform-${firstAvailablePlatform.id}`);
                currentPlatform = firstAvailablePlatform.id;
                if (firstButton) {
                    setActivePlatformButton(firstButton);
                }
            }
        }

        function setActivePlatformButton(activeButton) {
            document.querySelectorAll('.platform-button').forEach(btn => btn.classList.remove('active'));
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        twitterButton.addEventListener('click', () => setActiveShareButton(twitterButton));
        discordButton.addEventListener('click', () => setActiveShareButton(discordButton));
        otherButton.addEventListener('click', () => setActiveShareButton(otherButton));

        // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        helpButton.addEventListener('click', () => {
            window.open('setumei.html', '_blank');
        });

        // Web Share APIã‚’ä½¿ã£ãŸå…±æœ‰
        if (navigator.share) {
            nativeShareButton.addEventListener('click', async () => {
                const text = memoArea.value;
                const url = getCurrentVideoUrl();
                let shareText = text;

                // ãƒ†ã‚­ã‚¹ãƒˆã«URLãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€è¿½åŠ ã™ã‚‹
                if (url && !text.includes(url)) {
                    shareText = text ? `${text}\n${url}` : url;
                }

                try {
                    await navigator.share({
                        title: document.title,
                        text: shareText,
                    });
                } catch (error) {
                    console.error('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            });
        } else {
            // Web Share APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            nativeShareButton.style.display = 'none';
        }

        // ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showHelpModal() {
            alert("ãƒ»ã€Œæ¬¡ã®æ›²ã¸ã€ãƒœã‚¿ãƒ³ã§ã€é¸æŠä¸­ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«æ›²ã‚’å†ç”Ÿã—ã¾ã™ã€‚\nãƒ»ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®ã‚µã‚¤ãƒˆã®æ›²ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚\nãƒ»ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ¡ãƒ¢ã‚„æ„Ÿæƒ³ã‚’æ›¸ãè¾¼ã‚ã¾ã™ã€‚\nãƒ»ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆTwitter(X), Discordãªã©ï¼‰ã‚’æŠ¼ã™ã¨ã€å„ã‚¢ãƒ—ãƒªå‘ã‘ã®ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚\nãƒ»ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã¯ã€ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã®å…±æœ‰æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ï¼ˆå¯¾å¿œæ©Ÿç¨®ã®ã¿ï¼‰ã€‚\nãƒ»URLã« ?ippitsukamome.csv ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿½åŠ ã™ã‚‹ã¨ã€å¤–éƒ¨ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã™ã€‚");
        }

        function loadRandomVideo() {
            if (!currentPlatform || !videoIds[currentPlatform] || videoIds[currentPlatform].length === 0) {
                playerContainer.innerHTML = '<p>ã“ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§å†ç”Ÿã§ãã‚‹æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                currentVideoId = '';
                return;
            }

            const randomIndex = Math.floor(Math.random() * videoIds[currentPlatform].length);
            const videoId = videoIds[currentPlatform][randomIndex];
            currentVideoId = videoId;

            playerContainer.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢

            let embedUrl = '';
            switch (currentPlatform) {
                case 'youtube':
                case 'youtubemusic':
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    break;
                case 'niconico':
                    embedUrl = `https://embed.nicovideo.jp/watch/${videoId}`;
                    break;
                case 'spotify':
                    embedUrl = `https://open.spotify.com/embed/track/${videoId}`;
                    break;
            }

            if (embedUrl) {
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.frameBorder = "0";
                iframe.allowFullscreen = true;
                
                if (currentPlatform === 'youtube' || currentPlatform === 'youtubemusic') {
                    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                }
                
                playerContainer.appendChild(iframe);

                if (currentPlatform === 'niconico') {
                    const nicoScript = document.createElement('script');
                    nicoScript.type = 'text/javascript';
                    nicoScript.src = `https://embed.nicovideo.jp/watch/${videoId}/script?w=640&h=360`;
                    playerContainer.appendChild(nicoScript);
                }
            }
            
            // URLã‚’ãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ã«æŒ¿å…¥
            if (currentShareMode !== 'other') {
                insertVideoUrl();
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
        function showErrorMessage(message) {
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const existingError = document.getElementById('error-message');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.cssText = `
                background: rgba(255, 71, 87, 0.9);
                color: white;
                padding: 15px;
                margin: 20px auto;
                max-width: 640px;
                border-radius: 10px;
                text-align: center;
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(255, 71, 87, 0.3);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 71, 87, 0.4);
                animation: slideDown 0.3s ease-out;
            `;
            errorDiv.innerHTML = message;

            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰
            if (!document.querySelector('#error-animation-style')) {
                const style = document.createElement('style');
                style.id = 'error-animation-style';
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateY(-20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®å¾Œã«æŒ¿å…¥
            playerContainer.parentNode.insertBefore(errorDiv, playerContainer.nextSibling);

            // 5ç§’å¾Œã«è‡ªå‹•çš„ã«æ¶ˆå»
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => errorDiv.remove(), 300);
                }
            }, 5000);
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦å‹•ç”»IDã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        async function fetchAndSetupVideoIds() {
            const csvPath = getCsvPath();
            let usedFallback = false;
            let currentPath = csvPath;
            
            try {
                let response = await fetch(currentPath);
                
                // 404ã‚¨ãƒ©ãƒ¼ã‚„ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!response.ok) {
                    if (currentPath !== 'ippitsukamome.csv') {
                        console.warn(`CSVãƒ•ã‚¡ã‚¤ãƒ« "${currentPath}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${response.status}). ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                        showErrorMessage(`âš ï¸ æŒ‡å®šã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ« "${currentPath}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚`);
                        currentPath = 'ippitsukamome.csv';
                        usedFallback = true;
                        response = await fetch(currentPath);
                        
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                        if (!response.ok) {
                            throw new Error(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${response.status}`);
                        }
                    } else {
                        throw new Error(`CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${response.status}`);
                    }
                }

                const data = await response.text();
                
                // BOMã®é™¤å»
                const cleanData = data.charCodeAt(0) === 0xFEFF ? data.substring(1) : data;

                // å…¨ã¦ã®IDã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
                videoIds = { youtube: [], niconico: [], spotify: [], youtubemusic: [] };

                // CSVãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
                const lines = cleanData.split(/\r?\n/); // è¡Œã§åˆ†å‰²
                const ids = lines.flatMap(line => line.split(',').map(id => id.trim()).filter(id => id));
                
                if (ids.length === 0) {
                    throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªå‹•ç”»IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                ids.forEach(id => {
                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!validateVideoId(id, 'youtube') && !validateVideoId(id, 'niconico') && !validateVideoId(id, 'spotify')) {
                        console.warn(`ç„¡åŠ¹ãªå‹•ç”»ID: ${id}`);
                        return;
                    }

                    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ¤å®š
                    if (/^(sm|nm|so)[0-9]+$/.test(id)) { // niconico
                        videoIds.niconico.push(id);
                    } else if (/^[a-zA-Z0-9_-]{11}$/.test(id)) { // youtube, youtubemusic
                        videoIds.youtube.push(id);
                    } else if (/^[a-zA-Z0-9]{22}$/.test(id)) { // spotify
                        videoIds.spotify.push(id);
                    }
                });

                // æœ‰åŠ¹ãªå‹•ç”»IDãŒãªã„å ´åˆ
                const totalVideos = Object.values(videoIds).reduce((sum, arr) => sum + arr.length, 0);
                if (totalVideos === 0) {
                    throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«å†ç”Ÿå¯èƒ½ãªå‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ï¼‰
                updateTitle(usedFallback ? 'ippitsukamome.csv' : currentPath);
                createPlatformButtons();

            } catch (error) {
                errorLogger.log(error, 'CSV fetch and setup');
                console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                showErrorMessage(`âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:<br>${error.message}`);
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                playerContainer.innerHTML = `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        background: rgba(255, 71, 87, 0.1);
                        color: #ff4757;
                        font-weight: 600;
                        text-align: center;
                        padding: 20px;
                        border-radius: 18px;
                    ">
                        <div>
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ˜”</div>
                            <div>æ¥½æ›²ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                            <div style="font-size: 0.9em; margin-top: 10px; color: #666;">
                                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„
                            </div>
                        </div>
                    </div>
                `;
                currentVideoId = '';
            }
        }

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        function main() {
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ï¼‰
            updateTitle('ippitsukamome.csv');
            
            fetchAndSetupVideoIds()
                .then(() => {
                    // æœ€åˆã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                    const firstPlatform = Object.keys(videoIds).find(key => videoIds[key].length > 0);
                    if (firstPlatform) {
                        currentPlatform = firstPlatform;
                        setActivePlatformButton(document.getElementById(`platform-${currentPlatform}`));
                        loadRandomVideo();
                    }
                })
                .catch(error => {
                    console.error('åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    errorLogger.log(error, 'Main initialization');
                });
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        main();
    </script>

</body>
</html>
